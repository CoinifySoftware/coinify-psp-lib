!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("CoinifyPspLib",[],t):"object"==typeof exports?exports.CoinifyPspLib=t():e.CoinifyPspLib=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";n.r(t),console.log("*** Coinify PSP Library ***");var r=function(){function e(){this.cardNumber="",this.cardHolderName="",this.expirationMonth="",this.expirationYear="",this.CVV=0}return e.validate=function(e){if(!(e.cardNumber&&e.cardHolderName&&e.CVV&&e.expirationYear&&e.expirationMonth))throw new Error("Invalid card data")},e}(),a=function(){function e(){this.is3DS=!1,this.url="",this.callbackUrl="",this.PaReq=""}return e.validate=function(e){if(void 0===e.is3DS||!e.url||!e.callbackUrl||e.is3DS&&!e.PaReq)throw new Error("Invalid url data")},e}(),i=function(){function e(){}return e.prototype.get=function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=function(){4===r.readyState&&(200===r.status||0===r.status&&""!==r.responseText?t(JSON.parse(r.responseText||"{}")):n({url:e,status:r.status,body:r.responseText||""}))},r.send()})},e.prototype.post=function(e,t){return void 0===t&&(t={}),new Promise(function(n,r){var a=new XMLHttpRequest;a.open("POST",e),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.setRequestHeader("Content-Type","application/json"),a.onreadystatechange=function(){4===a.readyState&&(200===a.status||0===a.status&&""!==a.responseText?n(JSON.parse(a.responseText||"{}")):r({url:e,status:a.status,body:a.responseText||""}))},a.send(JSON.stringify(t))})},e}(),o=function(){function e(){this.provider={safecharge:{loaded:!1,loading:!1},isignthis:{loaded:!1,loading:!1}},this.overlay=void 0,this.loadingOverlay=void 0,this.container3ds=void 0,this.callbackUrl3DS="localhost:6564",this.callbackUrlPayment="localhost:1234",this.container3dsForm=void 0,this.container3dsi1=void 0,this.container3dsi2=void 0,this.container3dsFrame=void 0,this.istBaseUrl="https://verify.isignthis.com",this.containerPay=void 0,this.options={verbose:!1},this.containerIsOverlay=!1}return e.applyCardToTradeTransferInDetails=function(t,n){var r=n.psp||n.provider;if(void 0!==r&&r!==e.PSPType.safecharge)throw new Error("Invalid psp: "+r);if(!t||!t.transferIn)throw new Error("Invalid transfer In in trade info.");var a={card:{}};if(n.cardId||n.upoId||n.externalTokenId)a.card.externalTokenId=n.cardId||n.upoId||n.externalTokenId;else{if(!n.ccTempToken)throw new Error("externalTokenId/cardId/upoId or ccTempToken was not present amoungst the attributes when applying card data");a.card.ccTempToken=n.ccTempToken,a.card.returnUrl=n.returnUrl||"https://app.sandbox.coinify.com/"}return t.transferIn.details=a,t},e.prototype.uri=function(e){return"/"!=e[0]&&(e="/"+e),"http://localhost:8087"+e},e.prototype.createOverlay=function(){if(this.overlay)return this.overlay;this.log("Creating overlay");var e=this.overlay=document.createElement("div");e.className="c-overlay c-is-hidden",e.id="c-overlay";var t=document.getElementsByTagName("body")[0];t.appendChild(e);var n="\n      .c-is-hidden {\n        display: none;\n      }\n      .c-button-close {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        position: absolute;\n        top: 10px;\n        right: 10px;\n        cursor: pointer;\n        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAowAAAKMB8MeazgAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAB5SURBVDiNrZPRCcAwCEQfnUiySAZuF8kSWeH6Yz8KrQZMQAicJ+epAB0YwAmYJKIADLic0/GPPCbQAnLznCd/4NWUFfkgy1VjH8CryA95ApYltAiTRCZxpuoW+gz9WXE6NPeg+ra1UDIxGlWEObe4SGxY5fIxlc75Bkt9V4JS7KWJAAAAAElFTkSuQmCC59ef34356faa7edebc7ed5432ddb673d');\n      }\n      .c-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0,0,0,0.6);\n      }\n      .c-modal-content {\n        padding: 20px 30px;\n        width: 600px;\n        position: relative;\n        min-height: 300px;\n        margin: 5% auto 0;\n        background: #fff;\n      }\n      .c-stretch {\n        width: 100%;\n        height: 100%;\n      }\n    ",r=document.createElement("style");return r.type="text/css",r.styleSheet?r.styleSheet.cssText=n:r.appendChild(document.createTextNode(n)),(document.head||document.getElementsByTagName("head")[0]||t).appendChild(r),e},e.prototype.createLoadingOverlay=function(){if(this.loadingOverlay)return this.loadingOverlay;this.log("Creating loading overlay");var e=this.loadingOverlay=document.createElement("div");e.className="c-working-overlay c-is-hidden",e.id="c-working-overlay";var t=document.getElementsByTagName("body")[0];t.appendChild(e);var n="\n      .c-working-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0,0,0,0.6);\n        z-index: 15000000;\n      }\n    ",r=document.createElement("style");return r.type="text/css",r.styleSheet?r.styleSheet.cssText=n:r.appendChild(document.createTextNode(n)),(document.head||document.getElementsByTagName("head")[0]||t).appendChild(r),e},e.prototype.create3DSFrame=function(e,t,n,r){var a=this,i=this.container3ds;if(!i){var o=document.getElementsByTagName("body")[0];(i=this.container3ds=document.createElement("div")).style.backgroundColor="white";var s=this.container3dsForm=document.createElement("form"),d=this.container3dsi1=document.createElement("input"),c=this.container3dsi2=document.createElement("input"),l=this.container3dsFrame=document.createElement("iframe");i.className="c-stretch",s.setAttribute("target","coinify-3dsframe"),s.setAttribute("id","redirect-3ds"),s.setAttribute("method","post"),l.setAttribute("name","coinify-3dsframe"),l.className="c-stretch",d.setAttribute("type","hidden"),d.setAttribute("name","PaReq"),c.setAttribute("type","hidden"),c.setAttribute("name","TermUrl"),s.appendChild(d),s.appendChild(c),i.appendChild(s),i.appendChild(l),o.appendChild(i)}this.container3dsForm.setAttribute("action",e),this.container3dsi1.setAttribute("value",t),this.container3dsi2.setAttribute("value",n);var u,p=r;return u=function(e){if(0==(e.data?e.data.toString():"").indexOf("[SC-Embed]")){window.removeEventListener("message",u);var t=JSON.parse(e.data.replace("[SC-Embed]",""));"close"==t.command&&(i.parentNode&&(i.parentNode.removeChild(i),a.containerIsOverlay&&a.showOverlay(!1)),p&&(p(t.param),p=void 0))}},window.addEventListener("message",u,!0),setTimeout(function(){a.container3dsForm.submit()}),i},e.prototype.createPaymentFrame=function(e,t){var n=this,r=n.containerPay;if(!r){var a=document.getElementsByTagName("body")[0];(r=n.containerPay=document.createElement("div")).className="c-stretch";var i=document.createElement("iframe");i.setAttribute("id","redirect-pay"),i.setAttribute("name","coinify-paymentframe"),i.className="c-stretch",i.src=e,r.appendChild(i),a.appendChild(r)}var o,s=t;return o=function(e){var t=e.data?e.data.toString():"";if(0==t.indexOf("[SC-Embed]")){window.removeEventListener("message",o);var a=JSON.parse(t.replace("[SC-Embed]",""));"close"==a.command&&(r.parentNode&&(r.parentNode.removeChild(r),n.containerIsOverlay&&n.showOverlay(!1)),s&&(s(a.param),s=void 0))}},window.addEventListener("message",o,!0),r},e.prototype.showOverlay=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=null);var n=this.overlay;e||void 0===e?(n.classList.remove("c-is-hidden"),t&&t.appendChild(n)):n.classList.add("c-is-hidden")},e.prototype.showLoadingOverlay=function(e){void 0===e&&(e=!0);var t=this.createLoadingOverlay();e||void 0===e?t.classList.remove("c-is-hidden"):t.classList.add("c-is-hidden")},Object.defineProperty(e.prototype,"Safecharge",{get:function(){return window.Safecharge},enumerable:!0,configurable:!0}),e.prototype.initSafecharge=function(t){var n=this,r=this;r.log("Loading safecharge SDK");var a=document.createElement("script");a.type="text/javascript",a.src="https://cdn.safecharge.com/js/v1/safecharge.js",a.onload=function(){if(r.provider[e.PSPType.safecharge].loaded=!!n.Safecharge,r.provider[e.PSPType.safecharge].loading=!1,!r.provider[e.PSPType.safecharge].loaded)throw new Error("Failed to load Safecharge library");t(r.Safecharge)},document.getElementsByTagName("body")[0].appendChild(a)},e.prototype.init_iSignThis=function(t){var n=this,r=this;r.log("Initializing iSignThis");var a=document.createElement("script");a.src=r.istBaseUrl+"/js/isx-embed.js",a.async=!0,a.onload=function(){r.iSignThis=a,r.provider[e.PSPType.isignthis].loaded=!!n.Safecharge,r.provider[e.PSPType.isignthis].loading=!1,t(a)}},e.prototype.isProviderLoaded=function(t){var n=this;return(t=n.validatePSP(t))===e.PSPType.isignthis?!!n.iSignThis:!!n.Safecharge},e.prototype.getScriptForProvider=function(t){var n=this;return(t=n.validatePSP(t))===e.PSPType.isignthis?n.iSignThis:n.Safecharge},e.prototype.validatePSP=function(t,n){if(void 0===n&&(n=!0),!t&&n)return console.error("Payment service provider not defined, falling back on safecharge"),e.PSPType.safecharge;if(t!==e.PSPType.safecharge&&t!==e.PSPType.isignthis)throw new Error("Invalid psp :"+t);return t},e.prototype.initPSP=function(t){var n=this;if(t=n.validatePSP(t),n.provider[t].loading)throw new Error("Already loading");return new Promise(function(r,a){n.provider[t].loaded?r(n.getScriptForProvider(t)):(n.provider[t].loaded=!1,n.provider[t].loading=!0,t===e.PSPType.isignthis?n.init_iSignThis(r):t===e.PSPType.safecharge&&n.initSafecharge(r))})},e.prototype.createTemporaryCardToken=function(e,t){var n=this;return t=n.validatePSP(t),new Promise(function(r,a){n.initPSP(t).then(function(t){n.log("Creating ccTempToken with payload "+JSON.stringify(e||{})),t.card.createToken(e,function(e){r(e)})}).catch(function(e){console.error("Error ",e),a(e)})})},e.prototype.clearFrame=function(){},e.prototype.createiFrame=function(){},e.prototype.openPaymentUrl=function(e,t,n){var r=this;return t=r.validatePSP(t),a.validate(e),r.containerIsOverlay=!1,n||(n=r.createOverlay(),r.containerIsOverlay=!0,r.showOverlay()),new Promise(function(t,a){var i;if(e.is3DS){var o=e.callbackUrl||r.callbackUrl3DS;i=r.create3DSFrame(e.url,e.PaReq,o,t)}else o=e.callbackUrl||r.callbackUrlPayment,i=r.createPaymentFrame(e.url,t);n.appendChild(i)})},e.prototype.setOptions=function(e){this.options=e},e.prototype.log=function(e){this.options.verbose&&console.log("Coinify:",e)},e.prototype.registerCard=function(t){var n=this,a=this,i=t.card;if(!i)throw new Error("No card data");var o=!!t.saveCard;return r.validate(i),a.log("Registering card; saving card: "+(o?"persistent":"temporary")+"; retrieving store card payload"),new Promise(function(t,r){e.http.get(n.uri(e.urls.storeCardPayload)).then(function(e){var n=e.payload,s=e.psp;n.cardData=i,a.log("Registering card; Requesting ccTempToken"),a.createTemporaryCardToken(n,s).then(function(e){a.log("Registering card; Retrieved ccTempToken "+e.ccTempToken);var i=(e||{}).status;"SUCCESS"===i?o?(a.log("Registering card; saving cTempToken as userPaymentOption"),a.saveCardByTempToken(e.ccTempToken,n.sessionToken).then(function(e){a.log("Saved card: "+i),t(e)}).catch(r)):t(e):(console.error("Failed ",e),r("Failed "+i))}).catch(r)}).catch(r)})},e.prototype.open3DSecureUrlForTrade=function(t,n){void 0===n&&(n=null);var r=this,a=t;if(r.validatePSP(a.psp||a.provider),!a.acsUrl)throw new Error("TransferIn details did not contain an acsUrl");if(!a.paRequest)throw new Error("TransferIn details did not contain a paRequest");var i={PaRes:"",sessionToken:a.sessionToken,userTokenId:a.userTokenId,clientRequestId:a.clientRequestId,upoId:a.userPaymentOptionId||a.externalTokenId,clientUniqueId:a.clientUniqueId,orderId:a.orderId};return Object.keys(i).forEach(function(e){if(void 0===i[e])throw new Error("Missing argument "+e)}),new Promise(function(t,o){var s={url:a.acsUrl,PaReq:a.paRequest,is3DS:!0,callbackUrl:a.threeDSecureCallback||e.urls.threeDSecureCallback};r.log("Opening payment url"),r.openPaymentUrl(s,"safecharge",n).then(function(e){e?(i.PaRes=e.toString(),r.finalizePayment(i).then(function(e){r.log("Payment Result: "+e.status+" : "+e.reason),t(e)})):(console.error("Failed to retrieve 3DS response."),o({error:"failed to auth3d",error_code:-5435}))})})},e.prototype.finalizePayment=function(t){var n=this;if(!t.PaRes)throw new Error("Invalid argument; PARes");return new Promise(function(r,a){n.log("Finalizing trade."),e.http.post(n.uri("/cards/finalizePayment"),t).then(function(e){n.log("Finalized payment for trade."),r(e)}).catch(a)})},e.prototype.saveCardByTempToken=function(t,n){if(!t)throw new Error("invalid ccTempToken");if(!n)throw new Error("invalid sessionToken");return this.log("Saving card by temp token"),e.http.post(this.uri("/cards"),{ccTempToken:t,sessionToken:n})},e.prototype.getCardList=function(){var t=this;return new Promise(function(n,r){e.http.get(t.uri("cards")).then(function(e){n(e)}).catch(r)})},e.Register={Permanently:1,ForTemporaryUse:2},e.PSPType={safecharge:"safecharge",isignthis:"isignthis"},e.urls={storeCardPayload:"/cards/storeCardPayload",threeDSecureCallback:"https://immense-hamlet-63274.herokuapp.com/?pares",hostedPaymentPageCallback:"www.google.com"},e.http=new i,e}();function s(){var e=window.coinifyInstance;return e||(window.coinifyInstance=e=new o),e}function d(e){return s().registerCard(e)}function c(e,t){void 0===t&&(t=null);var n=e,r=s();return console.log("handle trade payment info ",n),n.acsUrl||n.paRequest?r.open3DSecureUrlForTrade(n,t):r.openPaymentUrl({url:n.redirectUrl,is3DS:!1,callbackUrl:n.returnUrl||o.urls.hostedPaymentPageCallback,PaReq:void 0},n.provider,t)}function l(e,t){return o.applyCardToTradeTransferInDetails(e,t)}function u(e,t,n){void 0===t&&(t="safecharge"),void 0===n&&(n=void 0);var r={url:e,is3DS:!1,callbackUrl:o.urls.hostedPaymentPageCallback,PaReq:void 0};return s().openPaymentUrl(r,t,n)}function p(){return s().getCardList()}function h(e){return s().setOptions(e)}n.d(t,"CardData",function(){return r}),n.d(t,"UrlData",function(){return a}),n.d(t,"CoinifyHttp",function(){return i}),n.d(t,"Coinify",function(){return o}),n.d(t,"getCoinifyInstance",function(){return s}),n.d(t,"registerCard",function(){return d}),n.d(t,"handleTradePaymentInfo",function(){return c}),n.d(t,"applyCardToTradeTransferInDetails",function(){return l}),n.d(t,"openHostedPaymentPage",function(){return u}),n.d(t,"getCardList",function(){return p}),n.d(t,"setOptions",function(){return h})},function(e,t,n){e.exports=n(0)}])});
//# sourceMappingURL=coinify-psp-lib.min.umd.js.map