!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("CoinifyPspLib",[],t):"object"==typeof exports?exports.CoinifyPspLib=t():e.CoinifyPspLib=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";n.r(t),console.log("*** Coinify PSP Library ***");var r=function(){function e(){this.cardNumber="",this.cardHolderName="",this.expirationMonth="",this.expirationYear="",this.CVV=0}return e.validate=function(e){if(!(e.cardNumber&&e.cardHolderName&&e.CVV&&e.expirationYear&&e.expirationMonth))throw new Error("Invalid card data")},e}(),i=function(){function e(){this.is3DS=!1,this.url="",this.callbackUrl="",this.PaReq=""}return e.validate=function(e){if(void 0===e.is3DS||!e.url||!e.callbackUrl||e.is3DS&&!e.PaReq)throw new Error("Invalid url data")},e}(),o=function(){function e(){}return e.prototype.get=function(e,t){return void 0===t&&(t=""),new Promise(function(n,r){var i=new XMLHttpRequest;i.open("GET",e),t&&""!==t&&i.setRequestHeader("Authorization","Bearer "+t),i.setRequestHeader("Content-Type","application/json"),i.onreadystatechange=function(){4===i.readyState&&(200===i.status||0===i.status&&""!==i.responseText?n(JSON.parse(i.responseText||"{}")):r({url:e,status:i.status,body:i.responseText||""}))},i.send()})},e.prototype.post=function(e,t,n){return void 0===t&&(t={}),void 0===n&&(n=""),new Promise(function(r,i){var o=new XMLHttpRequest;o.open("POST",e),n&&""!==n&&o.setRequestHeader("Authorization","Bearer "+n),o.setRequestHeader("Content-Type","application/json"),o.onreadystatechange=function(){4===o.readyState&&(200===o.status||0===o.status&&""!==o.responseText?r(JSON.parse(o.responseText||"{}")):i({url:e,status:o.status,body:o.responseText||""}))},o.send(JSON.stringify(t))})},e}(),a=function(){function e(){this.provider={safecharge:{loaded:!1,loading:!1},isignthis:{loaded:!1,loading:!1}},this.overlay=void 0,this.loadingOverlay=void 0,this.container3ds=void 0,this.callbackUrl3DS="localhost:6564",this.callbackUrlPayment="localhost:1234",this.coinifyApiBaseUrl="http://localhost:8087",this.container3dsForm=void 0,this.container3dsi1=void 0,this.container3dsi2=void 0,this.container3dsFrame=void 0,this.istBaseUrl="https://verify.isignthis.com",this.containerPay=void 0,this.options={verbose:!1,accessToken:""},this.containerIsOverlay=!1,this.cssLoaded=!1}return e.applyCardToTradeTransferInDetails=function(t,n){var r=n.psp||n.provider;if(void 0!==r&&r!==e.PSPType.safecharge)throw new Error("Invalid psp: "+r);if(!t||!t.transferIn)throw new Error("Invalid transfer In in trade info.");var i={card:{}};if(n.cardId||n.upoId||n.externalTokenId)i.card.externalTokenId=n.cardId||n.upoId||n.externalTokenId;else{if(!n.ccTempToken)throw new Error("externalTokenId/cardId/upoId or ccTempToken was not present amoungst the attributes when applying card data");i.card.ccTempToken=n.ccTempToken,i.card.returnUrl=n.returnUrl||"https://app.sandbox.coinify.com/"}return t.transferIn.details=i,t},e.prototype.uri=function(e){return"/"!=e[0]&&(e="/"+e),this.coinifyApiBaseUrl+e},e.prototype.createOverlay=function(){if(this.overlay)return this.overlay;this.log("Creating overlay");var e=this.overlay=document.createElement("div");return e.className="c-overlay c-is-hidden",e.id="c-overlay",document.getElementsByTagName("body")[0].appendChild(e),this.ensureCSSLoaded(),e},e.prototype.ensureCSSLoaded=function(){if(!this.cssLoaded){var e="\n      .c-is-hidden {\n        display: none;\n      }\n      .c-button-close {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        position: absolute;\n        top: 10px;\n        right: 10px;\n        cursor: pointer;\n        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAowAAAKMB8MeazgAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAB5SURBVDiNrZPRCcAwCEQfnUiySAZuF8kSWeH6Yz8KrQZMQAicJ+epAB0YwAmYJKIADLic0/GPPCbQAnLznCd/4NWUFfkgy1VjH8CryA95ApYltAiTRCZxpuoW+gz9WXE6NPeg+ra1UDIxGlWEObe4SGxY5fIxlc75Bkt9V4JS7KWJAAAAAElFTkSuQmCC59ef34356faa7edebc7ed5432ddb673d');\n      }\n      .c-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0,0,0,0.6);\n      }\n      .c-modal-content {\n        padding: 20px 30px;\n        width: 600px;\n        position: relative;\n        min-height: 300px;\n        margin: 5% auto 0;\n        background: #fff;\n      }\n      .c-stretch {\n        width: 100%;\n        height: 100%;\n      }\n      .c-working-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0,0,0,0.6);\n        z-index: 15000000;\n      }\n      .c-iframe {\n        min-height: 450px;\n      }\n    ",t=document.createElement("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e));var n=document.getElementsByTagName("body")[0];(document.head||document.getElementsByTagName("head")[0]||n).appendChild(t),this.cssLoaded=!1}},e.prototype.createLoadingOverlay=function(){if(this.loadingOverlay)return this.loadingOverlay;this.log("Creating loading overlay");var e=this.loadingOverlay=document.createElement("div");return e.className="c-working-overlay c-is-hidden",e.id="c-working-overlay",document.getElementsByTagName("body")[0].appendChild(e),this.ensureCSSLoaded(),e},e.prototype.create3DSFrame=function(e,t,n,r){var i=this,o=this.container3ds;if(!o){var a=document.getElementsByTagName("body")[0];(o=this.container3ds=document.createElement("div")).style.backgroundColor="white";var s=this.container3dsForm=document.createElement("form"),d=this.container3dsi1=document.createElement("input"),c=this.container3dsi2=document.createElement("input"),l=this.container3dsFrame=document.createElement("iframe");o.className="c-stretch",s.setAttribute("target","coinify-3dsframe"),s.setAttribute("id","redirect-3ds"),s.setAttribute("method","post"),l.setAttribute("name","coinify-3dsframe"),l.className="c-stretch",l.scrolling="no",l.setAttribute("style","border: none;"),d.setAttribute("type","hidden"),d.setAttribute("name","PaReq"),c.setAttribute("type","hidden"),c.setAttribute("name","TermUrl"),s.appendChild(d),s.appendChild(c),o.appendChild(s),o.appendChild(l),a.appendChild(o),this.ensureCSSLoaded()}this.container3dsForm.setAttribute("action",e),this.container3dsi1.setAttribute("value",t),this.container3dsi2.setAttribute("value",n);var p,u=r;return p=function(e){if(0==(e.data?e.data.toString():"").indexOf("[SC-Embed]")){window.removeEventListener("message",p);var t=JSON.parse(e.data.replace("[SC-Embed]",""));"close"==t.command&&(o.parentNode&&(o.parentNode.removeChild(o),i.containerIsOverlay&&i.showOverlay(!1)),u&&(u(t.param),u=void 0))}},window.addEventListener("message",p,!0),setTimeout(function(){i.container3dsForm.submit()}),o},e.prototype.createPaymentFrame=function(e,t){var n=this,r=n.containerPay;if(!r){var i=document.getElementsByTagName("body")[0];(r=n.containerPay=document.createElement("div")).className="c-stretch";var o=document.createElement("iframe");o.setAttribute("id","redirect-pay"),o.setAttribute("name","coinify-paymentframe"),o.className="c-stretch c-iframe",o.src=e,r.appendChild(o),i.appendChild(r),this.ensureCSSLoaded()}var a,s=t;return a=function(e){var t=e.data?e.data.toString():"";if(0==t.indexOf("[SC-Embed]")){window.removeEventListener("message",a);var i=JSON.parse(t.replace("[SC-Embed]",""));"close"==i.command&&(r.parentNode&&(r.parentNode.removeChild(r),n.containerIsOverlay&&n.showOverlay(!1)),s&&(s(i.param),s=void 0))}},window.addEventListener("message",a,!0),r},e.prototype.showOverlay=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=null);var n=this.overlay;e||void 0===e?(n.classList.remove("c-is-hidden"),t&&t.appendChild(n)):n.classList.add("c-is-hidden")},e.prototype.showLoadingOverlay=function(e){void 0===e&&(e=!0);var t=this.createLoadingOverlay();e||void 0===e?t.classList.remove("c-is-hidden"):t.classList.add("c-is-hidden")},Object.defineProperty(e.prototype,"Safecharge",{get:function(){return window.Safecharge},enumerable:!0,configurable:!0}),e.prototype.initSafecharge=function(t){var n=this,r=this;r.log("Loading safecharge SDK");var i=document.createElement("script");i.type="text/javascript",i.src="https://cdn.safecharge.com/js/v1/safecharge.js",i.onload=function(){if(r.provider[e.PSPType.safecharge].loaded=!!n.Safecharge,r.provider[e.PSPType.safecharge].loading=!1,!r.provider[e.PSPType.safecharge].loaded)throw new Error("Failed to load Safecharge library");t(r.Safecharge)},document.getElementsByTagName("body")[0].appendChild(i)},e.prototype.init_iSignThis=function(t){var n=this,r=this;r.log("Initializing iSignThis");var i=document.createElement("script");i.src=r.istBaseUrl+"/js/isx-embed.js",i.async=!0,i.onload=function(){r.iSignThis=i,r.provider[e.PSPType.isignthis].loaded=!!n.Safecharge,r.provider[e.PSPType.isignthis].loading=!1,t(i)}},e.prototype.isProviderLoaded=function(t){var n=this;return(t=n.validatePSP(t))===e.PSPType.isignthis?!!n.iSignThis:!!n.Safecharge},e.prototype.getScriptForProvider=function(t){var n=this;return(t=n.validatePSP(t))===e.PSPType.isignthis?n.iSignThis:n.Safecharge},e.prototype.validatePSP=function(t,n){if(void 0===n&&(n=!0),!t&&n)return console.error("Payment service provider not defined, falling back on safecharge"),e.PSPType.safecharge;if(t!==e.PSPType.safecharge&&t!==e.PSPType.isignthis)throw new Error("Invalid psp :"+t);return t},e.prototype.initPSP=function(t){var n=this;if(t=n.validatePSP(t),n.provider[t].loading)throw new Error("Already loading");return new Promise(function(r,i){n.provider[t].loaded?r(n.getScriptForProvider(t)):(n.provider[t].loaded=!1,n.provider[t].loading=!0,t===e.PSPType.isignthis?n.init_iSignThis(r):t===e.PSPType.safecharge&&n.initSafecharge(r))})},e.prototype.createTemporaryCardToken=function(e,t){var n=this;return t=n.validatePSP(t),new Promise(function(r,i){n.initPSP(t).then(function(t){n.log("Creating ccTempToken with payload "+JSON.stringify(e||{})),t.card.createToken(e,function(e){r(e)})}).catch(function(e){console.error("Error ",e),i(e)})})},e.prototype.openPaymentUrl=function(e,t,n){var r=this;return t=r.validatePSP(t),i.validate(e),r.containerIsOverlay=!1,n||(n=r.createOverlay(),r.containerIsOverlay=!0,r.showOverlay()),new Promise(function(t,i){var o;if(e.is3DS){var a=e.callbackUrl||r.callbackUrl3DS;o=r.create3DSFrame(e.url,e.PaReq,a,t)}else a=e.callbackUrl||r.callbackUrlPayment,o=r.createPaymentFrame(e.url,t);n.appendChild(o)})},e.prototype.setOptions=function(e){console.log("opts",e);var t=this;if(t.options){if(e)for(var n in e)t.options[n]=e[n]}else t.options=e;this.options?(t.options.coinifyApiBaseUrl&&(t.log("Setting Coinity API base url : "+t.options.coinifyApiBaseUrl),t.coinifyApiBaseUrl=t.options.coinifyApiBaseUrl),t.options.default3DSCallback&&(t.log("Setting Default 3DS callback url : "+t.options.default3DSCallback),t.callbackUrl3DS=t.options.default3DSCallback),t.options.defaultHostedPaymentCallback&&(t.log("Setting trade service url : "+t.options.defaultHostedPaymentCallback),t.callbackUrlPayment=t.options.defaultHostedPaymentCallback)):t.log("Failed to set options.")},e.prototype.log=function(e){this.options.verbose&&console.log("Coinify:",e)},e.prototype.registerCard=function(t){var n=this,i=this,o=t.card;if(!o)throw new Error("No card data");var a=!!t.saveCard;return r.validate(o),i.log("Registering card; saving card: "+(a?"persistent":"temporary")+"; retrieving store card payload"),new Promise(function(t,r){console.log("this.options.accessToken ",n.options.accessToken),e.http.get(n.uri(e.urls.storeCardPayload),n.options.accessToken).then(function(e){var n=Object.assign({},e.payload);n.sessionToken=n.sessionToken||e.sessionToken;var s=e.psp||e.provider;n.cardData=o,i.log("Registering card; Requesting ccTempToken"),i.createTemporaryCardToken(n,s).then(function(e){i.log("Registering card; Retrieved ccTempToken "+e.ccTempToken);var o=(e||{}).status;"SUCCESS"===o?a?(i.log("Registering card; saving cTempToken as userPaymentOption"),i.saveCardByTempToken(e.ccTempToken,n.sessionToken).then(function(e){i.log("Saved card: "+o),t(e)}).catch(r)):t(e):(console.error("Failed ",e),r("Failed "+o))}).catch(r)}).catch(r)})},e.prototype.open3DSecureUrlForTrade=function(t,n){void 0===n&&(n=null);var r=this,i=t;if(r.validatePSP(i.psp||i.provider),!i.acsUrl)throw new Error("TransferIn details did not contain an acsUrl");if(!i.paRequest)throw new Error("TransferIn details did not contain a paRequest");var o={PaRes:"",sessionToken:i.sessionToken,userTokenId:i.userTokenId,clientRequestId:i.clientRequestId,upoId:i.userPaymentOptionId||i.externalTokenId,clientUniqueId:i.clientUniqueId,orderId:i.orderId};return Object.keys(o).forEach(function(e){if(void 0===o[e])throw new Error("Missing argument "+e)}),new Promise(function(t,a){var s={url:i.acsUrl,PaReq:i.paRequest,is3DS:!0,callbackUrl:i.threeDSecureCallback||e.urls.threeDSecureCallback};r.log("Opening payment url"),r.openPaymentUrl(s,"safecharge",n).then(function(e){e?(o.PaRes=e.toString(),r.finalizePayment(o).then(function(e){r.log("Payment Result: "+e.status+" : "+e.reason),t(e)})):(console.error("Failed to retrieve 3DS response."),a({error:"failed to auth3d",error_code:-5435}))})})},e.prototype.finalizePayment=function(t){var n=this;if(!t.PaRes)throw new Error("Invalid argument; PARes");return new Promise(function(r,i){n.log("Finalizing trade."),e.http.post(n.uri(e.urls.finalizePayment),t,n.options.accessToken).then(function(e){n.log("Finalized payment for trade."),r(e)}).catch(i)})},e.prototype.saveCardByTempToken=function(t,n){if(!t)throw new Error("invalid ccTempToken");if(!n)throw new Error("invalid sessionToken");return this.log("Saving card by temp token"),e.http.post(this.uri(e.urls.cards),{ccTempToken:t,sessionToken:n},this.options.accessToken)},e.prototype.getCardList=function(){var t=this;return new Promise(function(n,r){e.http.get(t.uri(e.urls.cards),t.options.accessToken).then(function(e){n(e)}).catch(r)})},e.Register={Permanently:1,ForTemporaryUse:2},e.PSPType={safecharge:"safecharge",isignthis:"isignthis"},e.urls={threeDSecureCallback:"https://immense-hamlet-63274.herokuapp.com/?pares",hostedPaymentPageCallback:"www.google.com",storeCardPayload:"/cards/storeCardPayload",finalizePayment:"/cards/finalize-payment",cards:"/cards"},e.http=new o,e}();function s(){var e=window.coinifyInstance;return e||(window.coinifyInstance=e=new a),e}function d(e){return s().registerCard(e)}function c(e,t){void 0===t&&(t=null);var n=e,r=s();return console.log("handle trade payment info ",n),n.acsUrl||n.paRequest?r.open3DSecureUrlForTrade(n,t):r.openPaymentUrl({url:n.redirectUrl,is3DS:!1,callbackUrl:n.returnUrl||a.urls.hostedPaymentPageCallback,PaReq:void 0},n.provider,t)}function l(e,t){return a.applyCardToTradeTransferInDetails(e,t)}function p(e,t,n){void 0===t&&(t="safecharge"),void 0===n&&(n=void 0);var r={url:e,is3DS:!1,callbackUrl:a.urls.hostedPaymentPageCallback,PaReq:void 0};return s().openPaymentUrl(r,t,n)}function u(){return s().getCardList()}function f(e){return s().setOptions(e)}n.d(t,"CardData",function(){return r}),n.d(t,"UrlData",function(){return i}),n.d(t,"CoinifyHttp",function(){return o}),n.d(t,"Coinify",function(){return a}),n.d(t,"getCoinifyInstance",function(){return s}),n.d(t,"registerCard",function(){return d}),n.d(t,"handleTradePaymentInfo",function(){return c}),n.d(t,"applyCardToTradeTransferInDetails",function(){return l}),n.d(t,"openHostedPaymentPage",function(){return p}),n.d(t,"getCardList",function(){return u}),n.d(t,"setOptions",function(){return f})},function(e,t,n){e.exports=n(0)}])});
//# sourceMappingURL=coinify-psp-lib.min.umd.js.map